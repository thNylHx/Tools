name: åŒæ­¥ä¸Šæ¸¸è§„åˆ™å’Œæ¨¡å—

on:
  workflow_dispatch:
  schedule:
    - cron: '0 16,22,4,10 * * *'  # æ³¨ï¼šä»¥ä¸Šæ—¶é—´å‡ä¸ºä¸Šæµ·æ—¶é—´ï¼ˆ0:00ã€6:00ã€12:00ã€18:00 æ‰§è¡Œï¼‰

jobs:
  Update:
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Shanghai'
    steps:
      - name: æ£€å‡ºç›®æ ‡ä»“åº“  # æ‹‰å–ç›®æ ‡ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: thNylHx/Tools
          path: Tools-repo

      - name: ä¸‹è½½ Surge è§„åˆ™  # ä¸‹è½½å¹¶åˆå¹¶ Surge è§„åˆ™æ–‡ä»¶
        shell: bash
        run: |
          set -euo pipefail
          echo "å¼€å§‹ä¸‹è½½ Surge è§„åˆ™æ–‡ä»¶..."
          repo_name=$(basename "$GITHUB_REPOSITORY")
          if [[ "$repo_name" != "Tools" ]]; then
              echo "å½“å‰ä»“åº“ä¸æ˜¯ Toolsï¼Œè·³è¿‡æ‰§è¡Œã€‚"
              exit 0
          fi
          echo "åœ¨ Tools ä»“åº“ä¸­è¿è¡Œä»»åŠ¡"

          # åˆ›å»ºè§„åˆ™ç›®å½•
          echo "åˆ›å»ºè§„åˆ™ç›®å½•..."
          mkdir -p "Tools-repo/Ruleset/Surge/{Block,Media,Other}"  "Tools-repo/Ruleset/mihomo/Block" "Tools-repo/Surge/Module"
          
          # å®šä¹‰ä¸‹è½½å‡½æ•°ï¼šå‚æ•°1ä¸ºç›®æ ‡æ–‡ä»¶ï¼Œå…¶ä½™å‚æ•°ä¸º URL åˆ—è¡¨
          download_urls() {
            local target_file="$1"
            shift
            echo "æ¸…ç©ºç›®æ ‡æ–‡ä»¶ï¼š$target_file"
            : > "$target_file"
            for url in "$@"; do
              echo "ä¸‹è½½ URLï¼š$url"
              curl -f -L "$url" >> "$target_file" || { echo "ä¸‹è½½å¤±è´¥ï¼š$url"; exit 1; }
              echo "" >> "$target_file"
            done
          }

          # åˆå¹¶ å¹¿å‘Š è§„åˆ™
          download_urls "Tools-repo/Ruleset/Surge/Block/Ads_Block.list" \
            "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/BanAD.list" \
            "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/BanProgramAD.list" \
            "https://raw.githubusercontent.com/Abcd789JK/Tools/refs/heads/main/Ruleset/Surge/Block/BlockAds.list" \
            "https://raw.githubusercontent.com/ConnersHua/RuleGo/master/Surge/Ruleset/Extra/Reject/Tracking.list" \
            "https://raw.githubusercontent.com/ConnersHua/RuleGo/master/Surge/Ruleset/Extra/Reject/Malicious.list" \
            "https://raw.githubusercontent.com/ConnersHua/RuleGo/master/Surge/Ruleset/Extra/Reject/Advertising.list" \
            "https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Surge-RULE-SET.list" \
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/classical/category-ads-all.list"
          # åŒæ­¥å¹¿å‘Šè§„åˆ™åˆ° mihomo ç›®å½•
          cp Tools-repo/Ruleset/Surge/Block/Ads_Block.list Tools-repo/Ruleset/mihomo/Block/Ads_Block.list
          cp Tools-repo/Ruleset/Surge/Block/Ads_Block.list Tools-repo/Surge/Module/Ads_Block.sgmodule

          # åˆå¹¶ è„¸ä¹¦ è§„åˆ™
          download_urls "Tools-repo/Ruleset/Surge/Media/Facebook.list" \
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/facebook.list" \
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/facebook.list" \
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/instagram.list"

          # åˆå¹¶ å¥ˆé£ è§„åˆ™
          download_urls "Tools-repo/Ruleset/Surge/Media/Netflix.list" \
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/netflix.list" \
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/netflix.list"

          # åˆå¹¶ æ¨ç‰¹ è§„åˆ™
          download_urls "Tools-repo/Ruleset/Surge/Media/Twitter.list" \
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/twitter.list" \
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/twitter.list"

          # åˆå¹¶ æ²¹ç®¡ è§„åˆ™
          download_urls "Tools-repo/Ruleset/Surge/Media/YouTube.list" \
            "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/YouTubeMusic.list" \
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/youtube.list"

          # åˆå¹¶ è°·æ­Œ è§„åˆ™
          download_urls "Tools-repo/Ruleset/Surge/Other/Google.list" \
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/google.list" \
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/google.list"

          # åˆå¹¶ æµ·å¤– è§„åˆ™
          download_urls "Tools-repo/Ruleset/Surge/Other/Global.list" \
            "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ProxyGFWlist.list" \
            "https://raw.githubusercontent.com/Loyalsoldier/surge-rules/release/ruleset/gfw.txt" \
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/geolocation-!cn.list"

          # åˆå¹¶ æ¸¸æˆ è§„åˆ™
          download_urls "Tools-repo/Ruleset/Surge/Other/Game.list" \
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/steam.list" \
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/epicgames.list"

          # ä¸‹è½½å…¶ä»–å•ç‹¬è§„åˆ™æ–‡ä»¶
          files=(
            ##### Ads #####
            # MetaCubeX
            "Block/Ads_all.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/classical/category-ads-all.list"
            # ACL4SSR
            "Block/Ads_BanAD.list https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/BanAD.list"
            "Block/Ads_BanProgramAD.list https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/BanProgramAD.list"
            # limbopro
            "Block/Ads_Easylist_surge.list https://raw.githubusercontent.com/limbopro/Adblock4limbo/main/rule/Surge/easylist_surge.list"
            "Block/Ads_EasyListChina.list https://raw.githubusercontent.com/limbopro/Adblock4limbo/main/rule/Surge/easylistchina_surge.list"
            "Block/Ads_EasyPrivacy_surge.list https://raw.githubusercontent.com/limbopro/Adblock4limbo/main/rule/Surge/easyprivacy_surge.list"
            "Block/Ads_Adblock4limbo_surge.list https://raw.githubusercontent.com/limbopro/Adblock4limbo/main/Surge/rule/Adblock4limbo_surge.list"
            # ConnersHua
            "Block/Ads_Advertising.list https://raw.githubusercontent.com/ConnersHua/RuleGo/master/Surge/Ruleset/Extra/Reject/Advertising.list"
            "Block/Ads_Malicious.list https://raw.githubusercontent.com/ConnersHua/RuleGo/master/Surge/Ruleset/Extra/Reject/Malicious.list"
            "Block/Ads_Tracking.list https://raw.githubusercontent.com/ConnersHua/RuleGo/master/Surge/Ruleset/Extra/Reject/Tracking.list"
            # dler-io TG-Twilight geekdada Abcd789JK
            "Block/Ads_BlockAds.list https://raw.githubusercontent.com/Abcd789JK/Tools/refs/heads/main/Ruleset/Surge/Block/BlockAds.list"
            "Block/Ads_Dlerio.list https://raw.githubusercontent.com/dler-io/Rules/main/Surge/Surge%203/Provider/AdBlock.list"
            "Block/Ads_AWAvenue.list https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Surge-RULE-SET.list"
            "Block/Ads_Chinese.list https://raw.githubusercontent.com/geekdada/surge-list/master/domain-set/chinese-filter.txt"
            ##### Other #####
            # æœ¬åœ°/å±€åŸŸç½‘
            "Other/Private_ip.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/private.list"
            # PayPal
            "Other/PayPal.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/paypal.list"
            # Openai
            "Other/Openai.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/classical/openai.list"
            # Steam
            "Other/Steam.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/steam.list"
            # Epic
            "Other/Epic.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/epicgames.list"
            # è°·æ­Œ
            "Other/vGoogle.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/google.list"
            "Other/Google_ip.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/google.list"
            # Line
            "Other/Line.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/line.list"
            # å¾®è½¯
            "Other/GitHub.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/github.list"
            "Other/OneDrive.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/onedrive.list"
            "Other/Microsoft.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/microsoft.list"
            # æµ·å¤–
            "Other/GlobalGFWa.list https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ProxyGFWlist.list"
            "Other/GlobalGFW.list https://raw.githubusercontent.com/Loyalsoldier/surge-rules/release/ruleset/gfw.txt"
            "Other/Global_GFW.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/gfw.list"
            "Other/vGlobal.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/geolocation-!cn.list"
            # è‹¹æœ
            "Other/Apple.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/apple.list"
            "Other/AppleCN.list https://github.com/ACL4SSR/ACL4SSR/raw/master/Clash/Apple.list"
            # ä¸­å›½
            "Other/China.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/cn.list"
            "Other/China_ip.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/cn.list"
            "Other/ChinaASN.list https://raw.githubusercontent.com/missuo/ASN-China/main/ASN.China.list"

            ##### Media #####
            # æ²¹ç®¡
            "Media/vYouTube.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/youtube.list"
            "Media/YouTubeMusic.list https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/YouTubeMusic.list"
            # ç”µæŠ¥
            "Media/Telegram.list https://raw.githubusercontent.com/Repcz/Tool/X/Surge/Rules/Telegram.list"
            # æ¨ç‰¹
            "Media/vTwitter.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/twitter.list"
            "Media/Twitter_ip.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/twitter.list"
            # è„¸ä¹¦
            "Media/vFacebook.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/facebook.list"
            "Media/Facebook_ip.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/facebook.list"
            "Media/Instagram.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/instagram.list"
            # è¿ªå£«å°¼
            "Media/Disney.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/disney.list"
            # å¥ˆé£
            "Media/vNetflix.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/netflix.list"
            "Media/Netflix_ip.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/netflix.list"
            # Spotify
            "Media/Spotify.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/spotify.list"
            # TikTok
            "Media/TikTok.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/classical/tiktok.list"
            # æµ·å¤–åª’ä½“
            "Media/GlobalMedia.list https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ProxyMedia.list"
            # Bç«™æµ·å¤–
            "Media/BilibiliHMT.list https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/BilibiliHMT.list"
            # ä¸­å›½åª’ä½“
            "Media/ChinaMedia.list https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ChinaMedia.list"
            "Media/Bilibili.list https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/classical/bilibili.list"
          )
          for file in "${files[@]}"; do
              file_name=$(echo $file | cut -d " " -f 1)
              url=$(echo $file | cut -d " " -f 2)
              [[ "$url" =~ ^https?: ]] || url="https:$url"
              echo "ä¸‹è½½æ–‡ä»¶ï¼š$file_name"
              curl -f -L "$url" -o "Tools-repo/Ruleset/Surge/$file_name" || { echo "ä¸‹è½½å¤±è´¥ï¼š$url"; exit 1; }
          done

      - name: ä¿®æ­£è§„åˆ™å†…å®¹  # ä¿®æ­£è§„åˆ™æ–‡ä»¶æ ¼å¼åŠå†…å®¹
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar
          for file in Tools-repo/Ruleset/Surge/**/*.list Tools-repo/Ruleset/mihomo/Block/*.list Tools-repo/Surge/Module/Ads_Block.sgmodule; do
            if [[ -f "$file" ]]; then
              # åˆ é™¤ä»¥ "DOMAIN-REGEX," å¼€å¤´çš„è¡Œ
              sed -i '/^DOMAIN-REGEX,/d' "$file"
              # å°†ä»¥ç‚¹å·å¼€å¤´çš„è¡Œæ›¿æ¢ä¸º "DOMAIN-SUFFIX," å‰ç¼€
              sed -i 's/^\s*\./DOMAIN-SUFFIX,/' "$file"
              # ä¸ºæ²¡æœ‰å‰ç¼€çš„è§„åˆ™è¡Œæ·»åŠ  "DOMAIN," å‰ç¼€ï¼ˆè·³è¿‡æ³¨é‡Šã€ç©ºè¡Œã€CIDR è§„åˆ™ç­‰ï¼‰
              sed -i -E '
                /^\s*$/b;
                /^\s*[#;]/b;
                /^\s*\/\//b;
                /^\s*[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\/[0-9]+/b;
                /^\s*[0-9A-Fa-f:]+\/[0-9]+/b;
                /^DOMAIN,|^DOMAIN-SUFFIX,|^DOMAIN-KEYWORD,|^DOMAIN-WILDCARD,|^IP-CIDR,|^IP-CIDR6,|^IP-ASN,|^GEOIP,|^AND,|^OR,|^NOT,|^URL-REGEX,|^USER-AGENT,|^PROCESS-NAME,|^DEST-PORT,/b;
                s/^([^#])/DOMAIN,\1/
              ' "$file"
              # åˆ é™¤æ³¨é‡Šã€ç©ºè¡ŒåŠè¡Œå†…æ³¨é‡Šå†…å®¹
              sed -i -E '/^\s*[#;]/d; /^\s*\/\//d; /^$/d; s| //.*||' "$file"
              # åˆ é™¤æŒ‡å®šåŸŸå
              sed -i -e '/DOMAIN,this_ruleset_is_made_by_sukkaw.ruleset.skk.moe/d' "$file"
              # åˆ é™¤æŒ‡å®šçš„è§„åˆ™åŠ ",reject" åŠå…¶åç¼€å†…å®¹
              sed -i -E 's/,reject(,[^,]+)*$//I' "$file"
              # æ ¼å¼åŒ–é€—å·åˆ†éš”ç¬¦
              sed -i 's/, */,/g' "$file"
            else
              echo "æ–‡ä»¶ä¸å­˜åœ¨ï¼š$file"
            fi
          done

      - name: å¯¹è§„åˆ™è¿›è¡Œæ’åº  # å¯¹è§„åˆ™è¿›è¡Œåˆ†ç±»æ’åºå’Œå»é‡
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar
          for file in Tools-repo/Ruleset/Surge/**/*.list Tools-repo/Ruleset/mihomo/Block/*.list Tools-repo/Surge/Module/Ads_Block.sgmodule; do
            if [[ -f "$file" ]]; then
              # ä¸º IPv4 å’Œ IPv6 CIDR è§„åˆ™æ·»åŠ å‰ç¼€
              sed -i -E '/^IP-CIDR,/!{/^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\/[0-9]+/s/^/IP-CIDR,/}' "$file"
              sed -i -E '/^IP-CIDR6,/!{/^([a-fA-F0-9]*:){2,}[a-fA-F0-9]*\/[0-9]+/s/^/IP-CIDR6,/}' "$file"
              # ä½¿ç”¨ awk æŒ‰è§„åˆ™ç±»å‹æ’åº
              awk '
              /^DOMAIN,/           { print "0 " $0; next }
              /^DOMAIN-SUFFIX,/    { print "1 " $0; next }
              /^DOMAIN-KEYWORD,/   { print "2 " $0; next }
              /^DOMAIN-WILDCARD,/  { print "3 " $0; next }
              /^IP-CIDR,/          { print "4 " $0; next }
              /^IP-CIDR6,/         { print "5 " $0; next }
              /^IP-ASN,/           { print "6 " $0; next }
              /^PROCESS-NAME,/     { print "7 " $0; next }
              /^URL-REGEX,/        { print "8 " $0; next }
              /^USER-AGENT,/       { print "9 " $0; next }
              /^GEOIP,/            { print "10 " $0; next }
              /^AND,/              { print "11 " $0; next }
              /^OR,/               { print "12 " $0; next }
              /^NOT,/              { print "13 " $0; next }
              /^DEST-PORT,/        { print "14 " $0; next }
                                   { print "15 " $0; next }
              ' "$file" | sort -k1,1n -k2,2 | cut -d' ' -f2- > "$file.sorted" && mv "$file.sorted" "$file"
              # ä¸º CIDR è§„åˆ™æ·»åŠ  "no-resolve" åç¼€ï¼Œä½†è·³è¿‡ China_ip.list
              if [[ $(basename "$file") == "China_ip.list" ]]; then
                  echo "Skipping $file for no-resolve addition"
              else
                  awk '/^(IP-CIDR,|IP-CIDR6,|IP-ASN,)/ && !/,no-resolve/ {print $0",no-resolve"; next} {print}' "$file" > tmpfile && mv tmpfile "$file"
              fi
              # å»é™¤é‡å¤è§„åˆ™ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰
              awk '!seen[tolower($0)]++' "$file" > temp && mv temp "$file"
            else
              echo "æ–‡ä»¶ä¸å­˜åœ¨ï¼š$file"
            fi
          done

      - name: å¤„ç† Surge è§„åˆ™  # æ·»åŠ è§„åˆ™åç§°å’Œç»Ÿè®¡ä¿¡æ¯åˆ°æ–‡ä»¶å¤´
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar
          for file in Tools-repo/Ruleset/Surge/**/*.list; do
            if [[ -f "$file" ]]; then
              # è·å–å½“å‰è§„åˆ™åç§°
              file_names=$(basename "$file" .list)
              # åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å·²ç»æœ‰ headerï¼ˆç¬¬ä¸€è¡Œä»¥ "#!name" å¼€å¤´ï¼‰
              if [[ $(head -n1 "$file") == "#!name"* ]]; then
                header_exists=true
                # æå– headerï¼ˆç›´åˆ°ç¬¬ä¸€ç©ºè¡Œä¸ºæ­¢ï¼‰
                header=$(sed '/^$/q' "$file")
                # æå– header åçš„è§„åˆ™éƒ¨åˆ†
                rules_original=$(sed '1,/^$/d' "$file")
                # ä» header ä¸­è·å–æ—§çš„æ—¥æœŸ
                old_date=$(echo "$header" | grep '^#!date' | cut -d'=' -f2- | xargs)
              else
                header_exists=false
                rules_original=$(cat "$file")
              fi
              # ç»Ÿè®¡è§„åˆ™éƒ¨åˆ†çš„è¡Œæ•°
              line_count=$(echo "$rules_original" | wc -l)
              current_time=$(date "+%Y-%m-%d %H:%M:%S")
              update_needed=false
              if $header_exists; then
                file_mtime=$(stat -c "%y" "$file" | cut -d'.' -f1)
                if [[ "$file_mtime" != "$old_date" ]]; then
                  update_needed=true
                fi
              else
              # æ–‡ä»¶æ²¡æœ‰ headerï¼Œåˆ™éœ€è¦æ·»åŠ  header
              update_needed=true
              fi
              if $update_needed; then
                new_header=$(printf "#!name = %s\n#!count = %s\n#!date = %s\n\n\n" "$file_names" "$line_count" "$current_time")
                {
                  echo "$new_header"
                  echo "$rules_original"
                } > "$file"
                touch -m -d "$current_time" "$file"
                echo "æ–‡ä»¶å·²æ›´æ–°ï¼š$file"
              else
                echo "è§„åˆ™æ— å˜åŠ¨ï¼Œä¿ç•™åŸæ—¶é—´ï¼š$file"
              fi
            else
              echo "æ–‡ä»¶ä¸å­˜åœ¨ï¼š$file"
            fi
          done

      - name: å¤„ç† Surge æ¨¡å—  # æ·»åŠ è§„åˆ™åç§°å’Œç»Ÿè®¡ä¿¡æ¯åˆ°æ–‡ä»¶å¤´
        shell: bash
        run: |
          set -euo pipefail
          for file in Tools-repo/Surge/Module/Ads_Block.sgmodule; do
            if [[ -f "$file" ]]; then
              # æå–åŸæ–‡ä»¶ä¸­çš„è§„åˆ™éƒ¨åˆ†ï¼ˆä» [Rule] å¼€å§‹ï¼‰
              rules_original=$(mktemp)
              awk '/^\[Rule\]/{flag=1; print; next} flag' "$file" > "$rules_original"
              # è®¡ç®—å½“å‰è§„åˆ™æ•°é‡
              line_count=$(wc -l < "$rules_original")
              # è·å–å½“å‰æ¨é€æ—¶é—´ï¼ˆç”¨äºæ–°çš„ headerï¼‰
              update_time=$(date "+%Y-%m-%d %H:%M:%S")
              # æ„é€ æ–°æ–‡ä»¶å†…å®¹ï¼šæ–°çš„ header + å¤„ç†åçš„è§„åˆ™éƒ¨åˆ†
              tmpfile=$(mktemp)
              {
                # æ·»åŠ  header
                echo "#!name = Block ads | è‡ªç”¨å¹¿å‘Šæ‹¦æˆªè§„åˆ™åˆé›†"
                echo "#!desc = åç§°ï¼š è‡ªç”¨å¹¿å‘Šæ‹¦æˆªè§„åˆ™åˆé›†"
                echo "#!author = RuCu6 Keywos fmz200 å¯è‰ğŸ…¥ QingRex"
                echo "#!category = ğŸš« Block ads"
                echo "#!tag = å¹¿å‘Šæ‹¦æˆªè§„åˆ™åˆé›†"
                echo "#!count = $line_count"
                echo "#!date = $update_time"
                echo ""            # ç©ºè¡Œ
                # æ·»åŠ  [Rule] éƒ¨åˆ†
                echo "[Rule]"
                # å¤„ç†è§„åˆ™éƒ¨åˆ†
                awk -F, '{
                  rule = $1
                  if ($0 ~ /^AND,\(\(IP-CIDR,/ || $0 ~ /^AND,\(\(IP-CIDR6,/) {
                    print $0; next
                  }
                  sub(/,no-resolve/, "", $0)
                  if (rule=="DOMAIN-KEYWORD" || rule=="DOMAIN-SUFFIX" || rule=="DOMAIN") {
                    print $0",REJECT,extended-matching,pre-matching"
                  } else if (rule=="URL-REGEX" || rule=="USER-AGENT") {
                    print $0",REJECT,extended-matching"
                  } else if (rule=="AND") {
                    print $0",REJECT,pre-matching"
                  } else if (rule=="IP-CIDR" || rule=="IP-CIDR6") {
                    print $0",REJECT,no-resolve,pre-matching"
                  } else {
                    print $0
                  }
                }' "$rules_original"
              } > "$tmpfile"
              # ä»æ–°æ–‡ä»¶ä¸­æå–è§„åˆ™éƒ¨åˆ†
              rules_new=$(mktemp)
              awk '/^\[Rule\]/{flag=1; print; next} flag' "$tmpfile" > "$rules_new"
              # ä»…æ¯”è¾ƒè§„åˆ™éƒ¨åˆ†
              if diff "$rules_original" "$rules_new" > /dev/null; then
                # è§„åˆ™éƒ¨åˆ†æ²¡æœ‰å˜åŒ–ï¼Œä¸æ›´æ–°æ–‡ä»¶
                rm "$tmpfile" "$rules_original" "$rules_new"
                echo "æ–‡ä»¶æœªæ›´æ–°ï¼Œä¿ç•™åŸæ—¶é—´ï¼š$file"
              else
                # è§„åˆ™éƒ¨åˆ†æœ‰å˜åŒ–ï¼Œæ›´æ–°æ•´ä¸ªæ–‡ä»¶
                mv "$tmpfile" "$file"
                touch -m -d "$update_time" "$file"
                echo "æ–‡ä»¶å·²æ›´æ–°ï¼š$file"
                rm "$rules_original" "$rules_new"
              fi
            else
              echo "æ–‡ä»¶ä¸å­˜åœ¨ï¼š$file"
            fi
          done

      - name: ä¸‹è½½ mihomo è§„åˆ™  # ä¸‹è½½å¹¶ä¿å­˜ mihomo è§„åˆ™æ–‡ä»¶
        shell: bash
        run: |
          set -euo pipefail
          repo_name=$(basename "$GITHUB_REPOSITORY")
          if [[ "$repo_name" != "Tools" ]]; then
              echo "å½“å‰ä»“åº“ä¸æ˜¯ Toolsï¼Œè·³è¿‡æ‰§è¡Œã€‚"
              exit 0
          fi
          echo "åœ¨ Tools ä»“åº“ä¸­è¿è¡Œ mihomo è§„åˆ™ä»»åŠ¡"
          # åˆ›å»º mihomo è§„åˆ™ç›®å½•
          mkdir -p Tools-repo/Ruleset/mihomo/{geoip,geosite}
          files=(
            # geosite
            "geosite/Ads_all.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/category-ads-all.mrs"
            "geosite/Local.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/private.mrs"
            "geosite/China.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/cn.mrs"
            "geosite/Openai.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/openai.mrs"
            "geosite/PayPal.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/paypal.mrs"
            "geosite/Apple.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/apple.mrs"
            "geosite/Global.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/geolocation-!cn.mrs"
            "geosite/GlobalGFW.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/gfw.mrs"
            "geosite/Google.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/google.mrs"
            "geosite/YouTube.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/youtube.mrs"
            "geosite/Steam.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/steam.mrs"
            "geosite/Epic.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/epicgames.mrs"
            "geosite/Facebook.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/facebook.mrs"
            "geosite/Instagram.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/instagram.mrs"
            "geosite/Twitter.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/twitter.mrs"
            "geosite/Telegram.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/telegram.mrs"
            "geosite/Line.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/line.mrs"
            "geosite/GitHub.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/github.mrs"
            "geosite/OneDrive.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/onedrive.mrs"
            "geosite/Microsoft.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/microsoft.mrs"
            "geosite/Tiktok.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/tiktok.mrs"
            "geosite/Bilibili.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/bilibili.mrs"
            "geosite/Disney.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/disney.mrs"
            "geosite/Netflix.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/netflix.mrs"
            "geosite/Spotify.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/spotify.mrs"

            # geoip
            "geoip/Local.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/private.mrs"
            "geoip/China.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/cn.mrs"
            "geoip/Netflix.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/netflix.mrs"
            "geoip/Twitter.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/twitter.mrs"
            "geoip/Telegram.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/telegram.mrs"
            "geoip/Facebook.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/facebook.mrs"
            "geoip/Google.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/google.mrs"
          )
          for file in "${files[@]}"; do
              file_name=$(echo $file | cut -d " " -f 1)
              url=$(echo $file | cut -d " " -f 2)
              [[ "$url" =~ ^https?: ]] || url="https:$url"
              echo "ä¸‹è½½ mihomo æ–‡ä»¶ï¼š$file_name"
              curl -f -L "$url" -o "Tools-repo/Ruleset/mihomo/$file_name" || { echo "ä¸‹è½½å¤±è´¥ï¼š$url"; exit 1; }
          done

      - name: å¤„ç† mihomo è§„åˆ™  # æ·»åŠ è§„åˆ™åç§°å’Œç»Ÿè®¡ä¿¡æ¯åˆ°æ–‡ä»¶å¤´
        shell: bash
        run: |
          set -euo pipefail
          for file in Tools-repo/Ruleset/mihomo/Block/*.list; do
            if [[ -f "$file" ]]; then
              # åˆ é™¤æ— æ•ˆè§„åˆ™ï¼šåˆ é™¤ä»¥ USER-AGENTã€URL-REGEXã€AND,((URL-REGEX å’Œ AND,((IP-CIDR å¼€å¤´çš„è¡Œ
              sed -i -e '/^USER-AGENT/d' "$file"
              sed -i -e '/^URL-REGEX/d' "$file"
              sed -i -e '/^AND,((IP-CIDR/d' "$file"
              sed -i -e '/^AND,((URL-REGEX/d' "$file"
              # è·å–å½“å‰è§„åˆ™åç§°
              file_names=$(basename "$file" .list)
              # åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å·²ç»æœ‰ headerï¼ˆç¬¬ä¸€è¡Œä»¥ "#!name" å¼€å¤´ï¼‰
              if [[ $(head -n1 "$file") == "#!name"* ]]; then
                header_exists=true
                # æå– headerï¼ˆç›´åˆ°ç¬¬ä¸€ç©ºè¡Œä¸ºæ­¢ï¼‰
                header=$(sed '/^$/q' "$file")
                # æå– header åçš„è§„åˆ™éƒ¨åˆ†
                rules_original=$(sed '1,/^$/d' "$file")
                # ä» header ä¸­è·å–æ—§çš„æ—¥æœŸ
                old_date=$(echo "$header" | grep '^#!date' | cut -d'=' -f2- | xargs)
              else
                header_exists=false
                rules_original=$(cat "$file")
              fi
              # ç»Ÿè®¡è§„åˆ™éƒ¨åˆ†çš„è¡Œæ•°
              line_count=$(echo "$rules_original" | wc -l)
              current_time=$(date "+%Y-%m-%d %H:%M:%S")
              update_needed=false
              if $header_exists; then
                file_mtime=$(stat -c "%y" "$file" | cut -d'.' -f1)
                if [[ "$file_mtime" != "$old_date" ]]; then
                  update_needed=true
                fi
              else
              # æ–‡ä»¶æ²¡æœ‰ headerï¼Œåˆ™éœ€è¦æ·»åŠ  header
              update_needed=true
              fi
              if $update_needed; then
                new_header=$(printf "#!name = %s\n#!count = %s\n#!date = %s\n\n\n" "$file_names" "$line_count" "$current_time")
                {
                  echo "$new_header"
                  echo "$rules_original"
                } > "$file"
                touch -m -d "$current_time" "$file"
                echo "æ–‡ä»¶å·²æ›´æ–°ï¼š$file"
              else
                echo "è§„åˆ™æ— å˜åŠ¨ï¼Œä¿ç•™åŸæ—¶é—´ï¼š$file"
              fi
            else
              echo "æ–‡ä»¶ä¸å­˜åœ¨ï¼š$file"
            fi
          done

      - name: å…‹éš† LoonKissSurge ä»“åº“      # å…‹éš† LoonKissSurge ä»“åº“ï¼ˆä¼˜åŒ–é€Ÿåº¦ï¼‰
        run: |
          REPO_DIR="${{ github.workspace }}/LoonKissSurge"
          rm -rf "$REPO_DIR"  # ç¡®ä¿åˆ é™¤ä¸ä¼šæŠ¥é”™
          git clone --depth=1 --single-branch "https://github.com/QingRex/LoonKissSurge.git" "$REPO_DIR" \
            && echo "âœ… æˆåŠŸå…‹éš† LoonKissSurge ä»“åº“" \
            || { echo "âŒ å…‹éš†å¤±è´¥ï¼Œé€€å‡ºã€‚"; exit 1; }
            
      - name: é‡å»º Surge/QingRex ç›®å½•      # é‡å»º Surge/QingRex ç›®æ ‡ç›®å½•
        run: |
          TARGET_DIR="${{ github.workspace }}/Tools-repo/Surge/QingRex"
          rm -rf "$TARGET_DIR" && mkdir -p "$TARGET_DIR"
          echo "âœ… å·²é‡å»ºç›®å½• $TARGET_DIR"

      - name: åŒæ­¥ LoonKissSurge åˆ° Surge/QingRex      # åŒæ­¥ LoonKissSurge ä¸­çš„ Surge æ¨¡å—åˆ°ç›®æ ‡ç›®å½•
        run: |
          cp -r "${{ github.workspace }}/LoonKissSurge/Surge/." "${{ github.workspace }}/Tools-repo/Surge/QingRex/" \
            && echo "å·²åŒæ­¥ LoonKissSurge å†…å®¹åˆ° Surge/QingRex" \
            || { echo "å¤åˆ¶å¤±è´¥ï¼Œé€€å‡ºã€‚"; exit 1; }

      - name: è®¾ç½® Tools-repo è¿œç¨‹ URL      # è®¾ç½® Tools-repo ä»“åº“è¿œç¨‹ URLï¼ˆé€šè¿‡ TOKEN è¿›è¡Œèº«ä»½éªŒè¯ï¼‰
        run: |
          git config --global user.name "${{ secrets.USERNAME }}"
          git config --global user.email "${{ secrets.EMAIL }}"
          cd "${{ github.workspace }}/Tools-repo"
          git remote set-url origin "https://x-access-token:${{ secrets.TOKEN }}@github.com/${{ secrets.USERNAME }}/Tools.git"

      - name: æ¨é€æ›´æ–°åˆ° Tools-repo ä»“åº“      # æ£€æŸ¥å˜æ›´å¹¶æ¨é€æ›´æ–°åˆ° Tools-repo ä»“åº“ main åˆ†æ”¯
        shell: bash
        run: |
          set -euo pipefail
          echo "æ£€æŸ¥ä»“åº“æ›´æ–°çŠ¶æ€..."
          cd "${{ github.workspace }}/Tools-repo"
          git pull --rebase --autostash origin main
          if [[ -n $(git status --porcelain) ]]; then
            echo "æ£€æµ‹åˆ°å˜æ›´ï¼Œå¼€å§‹æäº¤æ›´æ–°..."
            git pull --rebase --autostash origin main
            git config --local user.name "GitHub Actions"
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "Auto Update $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
            git push origin main && echo "åŒæ­¥å®Œæˆï¼"
          else
            echo "æ²¡æœ‰å˜æ›´ï¼Œæ— éœ€åŒæ­¥ã€‚"
          fi

      - name: è®¾ç½®å½“å‰æ—¶é—´å˜é‡  # ä¿å­˜å½“å‰æ—¶é—´åˆ°ç¯å¢ƒå˜é‡ä¸­
        shell: bash
        run: |
          echo "time=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

      - name: å‘é€ Telegram é€šçŸ¥  # é€šè¿‡ Telegram å‘é€æ‰§è¡Œé€šçŸ¥
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ğŸ“¢ é€šçŸ¥
            ğŸš€ æ¥æºï¼šGitHub Actions
            âœ‰ï¸ æ ‡é¢˜ï¼šåŒæ­¥ä¸Šæ¸¸è§„åˆ™å’Œæ¨¡å—
            ğŸ“¦ ä»“åº“ï¼šJK_567
            â° æ—¶é—´ï¼š${{ env.time }}
            ğŸ‰ çŠ¶æ€ï¼šå…¨éƒ¨ä»»åŠ¡æˆåŠŸæ‰§è¡Œ

      - name: æ¸…ç†å·¥ä½œæµè®°å½•  # åˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 2
          