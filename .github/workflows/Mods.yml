name: Surge æ¨¡å—æ‹‰å–

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: "35 */12 * * *"  # æ¯12å°æ—¶è§¦å‘ä¸€æ¬¡

jobs:
  Fork-Filter-List:
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Shanghai'  # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·

    steps:
    - name: æ£€å‡ºç›®æ ‡ä»“åº“
      # å…‹éš†ç›®æ ‡ä»“åº“ï¼ˆToolsï¼‰
      uses: actions/checkout@v4.1.0
      with:
        repository: thNylHx/Tools
        path: Tools-repo

    - name: è®¾ç½® Git é…ç½®
      # é…ç½® Git ç”¨æˆ·åå’Œé‚®ç®±
      run: |
        git config --global user.name "${{ secrets.USERNAME }}"
        git config --global user.email "${{ secrets.EMAIL }}"
    
    - name: å…‹éš† LoonKissSurge ä»“åº“
      # å§‹ç»ˆæ‰§è¡Œå…‹éš† LoonKissSurge ä»“åº“çš„æ“ä½œ
      run: |
        rm -rf "${{ github.workspace }}/LoonKissSurge"  # ç¡®ä¿æ¸…ç©ºç›®å½•
        git clone "https://github.com/QingRex/LoonKissSurge.git" "${{ github.workspace }}/LoonKissSurge" && echo "æˆåŠŸå…‹éš† LoonKissSurge ä»“åº“" || { echo "å…‹éš†å¤±è´¥ï¼Œé€€å‡ºã€‚"; exit 1; }

    - name: å…‹éš† Tools ä»“åº“
      # å§‹ç»ˆæ‰§è¡Œå…‹éš† Tools ä»“åº“çš„æ“ä½œ
      run: |
        rm -rf "${{ github.workspace }}/Tools"  # ç¡®ä¿æ¸…ç©ºç›®å½•
        git clone "https://github.com/${{ secrets.USERNAME }}/Tools.git" "${{ github.workspace }}/Tools" && echo "æˆåŠŸå…‹éš† Tools ä»“åº“" || { echo "å…‹éš†å¤±è´¥ï¼Œé€€å‡ºã€‚"; exit 1; }
    
    - name: é‡å»º Surge Mods ç›®å½•
      # é‡å»º Surge/Mods ç›®å½•
      run: |
        SURGE_MODS_DIR="${{ github.workspace }}/Tools/Surge/Mods"
        rm -rf "$SURGE_MODS_DIR" && mkdir -p "$SURGE_MODS_DIR"
        echo "å·²é‡å»º Surge/Mods ç›®å½•ã€‚"

    - name: å¤åˆ¶å¹¶é‡å‘½å Beta æ–‡ä»¶å†…å®¹
      # ä» LoonKissSurge ä»“åº“çš„ Beta ç›®å½•å¤åˆ¶æ–‡ä»¶åˆ° Tools ä»“åº“çš„ Surge/Mods ç›®å½•
      run: |
        if [ -d "${{ github.workspace }}/LoonKissSurge/Surge/Beta" ]; then
          cp -r "${{ github.workspace }}/LoonKissSurge/Surge/Beta/"* "${{ github.workspace }}/Tools/Surge/Mods/" && echo "å·²æ‹·è´ Beta æ–‡ä»¶è‡³ Surge/Mods"
          
          echo "åŒ¹é…çš„æ–‡ä»¶ï¼š"
          # åˆ—å‡º Surge/Mods ç›®å½•ä¸‹çš„ .sgmodule æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™è¾“å‡ºæç¤º
          ls "${{ github.workspace }}/Tools/Surge/Mods"/*.sgmodule || echo "æ²¡æœ‰æ‰¾åˆ° .sgmodule æ–‡ä»¶"
          
          # éå†æ‰€æœ‰ .sgmodule æ–‡ä»¶ï¼Œè¿›è¡Œæ–‡ä»¶åé‡å‘½å
          for file in "${{ github.workspace }}/Tools/Surge/Mods"/*.sgmodule; do
            if [ -e "$file" ]; then
              # ä½¿ç”¨ sed åˆ é™¤æ–‡ä»¶åä¸­çš„ "å»å¹¿å‘Š" å’Œ ".beta"
              new_name=$(echo "$file" | sed 's/å»å¹¿å‘Š//g' | sed 's/\.beta//g')
              if [ "$file" != "$new_name" ]; then
                mv "$file" "$new_name"  # é‡å‘½åæ–‡ä»¶
                echo "å·²å°† $file é‡å‘½åä¸º $new_name"
              else
                echo "æ–‡ä»¶ $file ä¸éœ€è¦é‡å‘½å"
              fi
            fi
          done
        else
          # å¦‚æœæœªæ‰¾åˆ° Beta ç›®å½•ï¼Œè¾“å‡ºé”™è¯¯å¹¶é€€å‡º
          echo "æœªæ‰¾åˆ° ${GITHUB_WORKSPACE}/LoonKissSurge/Surge/Beta ç›®å½•ï¼Œé€€å‡ºã€‚"
          exit 1
        fi

    - name: ä¸º Tools ä»“åº“è®¾ç½®è¿œç¨‹ URL
      # è®¾ç½®è¿œç¨‹ä»“åº“çš„ URLï¼Œä½¿ç”¨ GitHub Token è¿›è¡Œèº«ä»½éªŒè¯
      run: |
        cd "${{ github.workspace }}/Tools"
        git remote set-url origin "https://x-access-token:${{ secrets.TOKEN }}@github.com/${{ secrets.USERNAME }}/Tools.git"

    - name: æ£€æŸ¥æ›´æ”¹å¹¶æ¨é€åˆ° GitHub Tools ä»“åº“
      id: push_changes
      # æ£€æŸ¥æœ¬åœ°ä»“åº“æ˜¯å¦æœ‰å˜æ›´ï¼Œå¹¶å°†å˜æ›´æ¨é€åˆ° GitHub
      run: |
        cd "${{ github.workspace }}/Tools"
        git fetch origin
        if [ -n "$(git status --porcelain)" ]; then
          git add -A
          git commit -m "Auto Update $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin main && echo "åŒæ­¥å®Œæˆï¼"
          echo "::set-output name=status::updated"
        else
          echo "æ²¡æœ‰æœ¬åœ°å˜æ›´ï¼Œæ— éœ€åŒæ­¥ã€‚"
          echo "::set-output name=status::no_update"
        fi
        
    - name: æ¨é€é€šçŸ¥åˆ° Telegram
      # æ¨é€æ›´æ–°é€šçŸ¥åˆ° Telegram
      if: always()
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # æ ¹æ®ä¸Šä¸€æ­¥çš„è¾“å‡ºçŠ¶æ€åˆ¤æ–­æ¨é€çš„æ¶ˆæ¯å†…å®¹
        if [ "${{ steps.push_changes.outputs.status }}" == "updated" ]; then
          STATUS="âœ… å·¥ä½œæµå®Œæˆï¼Œä»“åº“ç±»å®¹æ›´æ–°æˆåŠŸã€‚"
        elif [ "${{ steps.push_changes.outputs.status }}" == "no_update" ]; then
          STATUS="ğŸ”” å·¥ä½œæµå®Œæˆï¼Œæœ¬æ¬¡æ²¡æœ‰å†…å®¹æ›´æ–°ã€‚"
        else
          STATUS="âŒ å·¥ä½œæµå¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚"
        fi
        
        # å‘é€çŠ¶æ€æ¶ˆæ¯åˆ° Telegram
        MESSAGE=$'ğŸ“¢ **é€šçŸ¥**'$'\nğŸ“¨ æ ‡é¢˜ï¼š'Surge æ¨¡å—æ‹‰å–$'\nğŸ”„ çŠ¶æ€ï¼š'"${STATUS}"$'\nğŸ•’ æ—¶é—´ï¼š'"$(date +'%Y-%m-%d %H:%M:%S')"
        
        # ä½¿ç”¨ curl å°†æ¶ˆæ¯å‘é€åˆ° Telegram
        curl -s -X POST https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage \
          -d chat_id=$TELEGRAM_CHAT_ID \
          -d text="$MESSAGE" \
          -d parse_mode="Markdown"

    - name: æ¸…ç†å·¥ä½œæµ
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 0
        keep_minimum_runs: 5