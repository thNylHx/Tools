name: åŒæ­¥ LoonKissSurge ä»“åº“å†…å®¹

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  schedule:
    - cron: "15 */6 * * *"  # å®šæ—¶è§¦å‘ï¼Œæ¯6å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰

jobs:
  sync-loonkisssurge:
    runs-on: ubuntu-latest  # åœ¨æœ€æ–°ç‰ˆæœ¬çš„ Ubuntu ç¯å¢ƒä¸­è¿è¡Œå·¥ä½œæµ
    env:
      TZ: 'Asia/Shanghai'  # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·æ—¶é—´

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºå½“å‰ä»“åº“ä»£ç 
      - name: æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}  # æ£€å‡ºå½“å‰ä»“åº“
          path: .  # å°†ä»“åº“æ£€å‡ºåˆ°å½“å‰ç›®å½•

      # æ­¥éª¤2ï¼šè®¾ç½® Git ç”¨æˆ·é…ç½®ï¼ˆç”¨äºåç»­æäº¤ï¼‰
      - name: è®¾ç½® Git é…ç½®
        run: |
          git config --global user.name "${{ secrets.USERNAME }}"
          git config --global user.email "${{ secrets.EMAIL }}"

      # æ­¥éª¤3ï¼šæ·»åŠ æºä»“åº“ä½œä¸ºè¿œç¨‹æº
      - name: æ·»åŠ æºä»“åº“è¿œç¨‹æº
        run: |
          git remote add upstream https://github.com/QingRex/LoonKissSurge.git

      # æ­¥éª¤4ï¼šè·å–æºä»“åº“çš„æœ€æ–°æ›´æ”¹
      - name: è·å–æºä»“åº“æ›´æ”¹
        run: |
          git fetch upstream

      # æ­¥éª¤5ï¼šåˆ›å»ºå¹¶åˆ‡æ¢åˆ°åŒæ­¥åˆ†æ”¯
      - name: åˆ›å»ºå¹¶åˆ‡æ¢åˆ°åŒæ­¥åˆ†æ”¯
        run: |
          git checkout -b sync-loonkisssurge

      # æ­¥éª¤6ï¼šæ¸…ç†ç›®æ ‡ç›®å½•å¹¶åˆ›å»ºæ‰€éœ€ç›®å½•ç»“æ„
      - name: æ¸…ç†å¹¶åˆ›å»ºç›®æ ‡ç›®å½•
        run: |
          rm -rf Tools/Surge/QingRex
          mkdir -p Tools/Surge/QingRex

      # æ­¥éª¤7ï¼šå°†æºä»“åº“å†…å®¹å¤åˆ¶åˆ°ç›®æ ‡ç›®å½•
      - name: å¤åˆ¶æºä»“åº“å†…å®¹åˆ°ç›®æ ‡ç›®å½•
        run: |
          cp -r ../LoonKissSurge/* Tools/Surge/QingRex/

      # æ­¥éª¤8ï¼šæ£€æŸ¥æ›´æ”¹å¹¶æ¨é€åˆ°å½“å‰ä»“åº“
      - name: æ£€æŸ¥å¹¶æ¨é€æ›´æ”¹
        run: |
          git add -A
          git commit -m "åŒæ­¥ LoonKissSurge ä»“åº“å†…å®¹ $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin sync-loonkisssurge

      # æ­¥éª¤9ï¼šå‘é€ Telegram æ¨é€é€šçŸ¥
      - name: å‘é€ Telegram é€šçŸ¥
        run: |
          MESSAGE="ğŸ“¢ é€šçŸ¥\nâœ‰ï¸ æ ‡é¢˜ï¼šLoonKissSurge ä»“åº“åŒæ­¥\nğŸ”” çŠ¶æ€ï¼šæˆåŠŸ\nâ° æ—¶é—´ï¼š$(date +'%Y-%m-%d %H:%M:%S')"
          curl -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${MESSAGE}"

      # æ­¥éª¤10ï¼šæ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•ï¼ˆå¯é€‰ï¼‰
      - name: æ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 5
