name: 同步 LoonKissSurge 仓库内容

on:
  workflow_dispatch:  # 允许手动触发工作流
  schedule:
    - cron: "15 */6 * * *"  # 定时触发，每6小时执行一次（UTC时间）

jobs:
  sync-loonkisssurge:
    runs-on: ubuntu-latest  # 在最新版本的 Ubuntu 环境中运行工作流
    env:
      TZ: 'Asia/Shanghai'  # 设置时区为上海时间

    steps:
      # 步骤1：检出当前仓库代码
      - name: 检出当前仓库代码
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}  # 检出当前仓库
          path: .  # 将仓库检出到当前目录

      # 步骤2：设置 Git 用户配置（用于后续提交）
      - name: 设置 Git 配置
        run: |
          git config --global user.name "${{ secrets.USERNAME }}"
          git config --global user.email "${{ secrets.EMAIL }}"

      # 步骤3：添加源仓库作为远程源
      - name: 添加源仓库远程源
        run: |
          git remote add upstream https://github.com/QingRex/LoonKissSurge.git

      # 步骤4：获取源仓库的最新更改
      - name: 获取源仓库更改
        run: |
          git fetch upstream

      # 步骤5：创建并切换到同步分支
      - name: 创建并切换到同步分支
        run: |
          git checkout -b sync-loonkisssurge

      # 步骤6：清理目标目录并创建所需目录结构
      - name: 清理并创建目标目录
        run: |
          rm -rf Tools/Surge/QingRex
          mkdir -p Tools/Surge/QingRex

      # 步骤7：将源仓库内容复制到目标目录
      - name: 复制源仓库内容到目标目录
        run: |
          cp -r ../LoonKissSurge/* Tools/Surge/QingRex/

      # 步骤8：检查更改并推送到当前仓库
      - name: 检查并推送更改
        run: |
          git add -A
          git commit -m "同步 LoonKissSurge 仓库内容 $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin sync-loonkisssurge

      # 步骤9：发送 Telegram 推送通知
      - name: 发送 Telegram 通知
        run: |
          MESSAGE="📢 通知\n✉️ 标题：LoonKissSurge 仓库同步\n🔔 状态：成功\n⏰ 时间：$(date +'%Y-%m-%d %H:%M:%S')"
          curl -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${MESSAGE}"

      # 步骤10：清理工作流运行记录（可选）
      - name: 清理工作流运行记录
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 5
