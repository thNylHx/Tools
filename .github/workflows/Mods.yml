name: åŒæ­¥ LoonKissSurge ä»“åº“å†…å®¹

# å®šä¹‰è§¦å‘è¯¥å·¥ä½œæµçš„äº‹ä»¶
on:
  # å…è®¸é€šè¿‡ GitHub ç•Œé¢æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  schedule:  # å®šæ—¶è§¦å‘è®¾ç½®
    # è®¾ç½®å®šæ—¶è§¦å‘è§„åˆ™ï¼Œä½¿ç”¨ cron è¯­æ³•è¡¨ç¤ºæ¯6å°æ—¶è§¦å‘ä¸€æ¬¡
    - cron: "0 */6 * * *"  # æ¯6å°æ—¶æ‰§è¡Œä¸€æ¬¡å·¥ä½œæµï¼ˆåˆ†é’Ÿä¸º0ï¼Œæ¯6å°æ—¶ä¸€æ¬¡ï¼‰

# å·¥ä½œæµ
jobs:
  sync:
    # æŒ‡å®šè¿è¡Œç¯å¢ƒä¸ºæœ€æ–°ç‰ˆæœ¬çš„ Ubuntu
    runs-on: ubuntu-latest  # åœ¨ ubuntu-latest ç¯å¢ƒä¸­è¿è¡Œä»»åŠ¡
    env:
      # è®¾ç½®ç¯å¢ƒå˜é‡ TZ ä¸ºä¸Šæµ·æ—¶é—´ï¼Œç¡®ä¿ä»»åŠ¡ä¸­çš„æ—¶é—´ä¸ä¸Šæµ·æ—¶åŒºä¸€è‡´
      TZ: 'Asia/Shanghai'  # é…ç½®æ—¶åŒºä¸º Asia/Shanghai

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºç›®æ ‡ä»“åº“
      - name: æ£€å‡ºç›®æ ‡ä»“åº“  # å®šä¹‰æ­¥éª¤åç§°ï¼šæ£€å‡ºç›®æ ‡ä»“åº“
        uses: actions/checkout@v4  # ä½¿ç”¨ GitHub å®˜æ–¹ checkout action æ£€å‡ºä»£ç 
        with:
          # æŒ‡å®šéœ€è¦æ£€å‡ºçš„è¿œç¨‹ä»“åº“ï¼Œæ ¼å¼ä¸ºâ€œç”¨æˆ·å/ä»“åº“åâ€
          repository: thNylHx/Tools  # ç›®æ ‡ä»“åº“ï¼šthNylHx/Tools
          # è®¾ç½®å°†ä»“åº“æ£€å‡ºåˆ°æœ¬åœ°çš„ç›®å½•åç§°ä¸º Tools
          path: Tools  # æœ¬åœ°ç›®å½•åç§°ï¼šTool

      # æ­¥éª¤ 2ï¼šè®¾ç½® Git ç”¨æˆ·é…ç½®
      - name: è®¾ç½® Git é…ç½®
        run: |
          git config --global user.name "${{ secrets.USERNAME }}"
          # git config --global user.email "${{ secrets.EMAIL }}"

      # 2. å…‹éš† LoonKissSurge ä»“åº“åˆ°å·¥ä½œç›®å½•
      - name: å…‹éš† LoonKissSurge ä»“åº“
        run: |
          rm -rf "${{ github.workspace }}/LoonKissSurge"
          git clone "https://github.com/QingRex/LoonKissSurge.git" "${{ github.workspace }}/LoonKissSurge" \
            && echo "æˆåŠŸå…‹éš† LoonKissSurge ä»“åº“" \
            || { echo "å…‹éš†å¤±è´¥ï¼Œé€€å‡ºã€‚"; exit 1; }

      # 3. é‡å»º Surge/QingRex ç›®æ ‡ç›®å½•
      - name: é‡å»º Surge/QingRex ç›®å½•
        run: |
          TARGET_DIR="${{ github.workspace }}/Tools/Surge/QingRex"
          rm -rf "$TARGET_DIR" && mkdir -p "$TARGET_DIR"
          echo "å·²é‡å»ºç›®å½• $TARGET_DIR"

      # 4. åŒæ­¥ LoonKissSurge ä¸­çš„ Surge æ¨¡å—åˆ°ç›®æ ‡ç›®å½•
      - name: åŒæ­¥ LoonKissSurge åˆ° Surge/QingRex
        run: |
          cp -r "${{ github.workspace }}/LoonKissSurge/Surge/." "${{ github.workspace }}/Tools/Surge/QingRex/" \
            && echo "å·²åŒæ­¥ LoonKissSurge å†…å®¹åˆ° Surge/QingRex" \
            || { echo "å¤åˆ¶å¤±è´¥ï¼Œé€€å‡ºã€‚"; exit 1; }

      # 5. è®¾ç½® Tools ä»“åº“è¿œç¨‹ URLï¼ˆé€šè¿‡ TOKEN è¿›è¡Œèº«ä»½éªŒè¯ï¼‰
      - name: è®¾ç½® Tools è¿œç¨‹ URL
        run: |
          cd "${{ github.workspace }}/Tools"
          git remote set-url origin "https://x-access-token:${{ secrets.TOKEN }}@github.com/${{ secrets.USERNAME }}/Tools.git"

      # 6. æ£€æŸ¥å˜æ›´å¹¶æ¨é€æ›´æ–°åˆ° Tools ä»“åº“ main åˆ†æ”¯
      - name: æ¨é€æ›´æ–°åˆ° Tools ä»“åº“
        run: |
          cd "${{ github.workspace }}/Tools"
          git fetch origin
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "Auto Update $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
            git push origin main && echo "åŒæ­¥å®Œæˆï¼"
          else
            echo "æ²¡æœ‰å˜æ›´ï¼Œæ— éœ€åŒæ­¥ã€‚"
          fi

      # æ­¥éª¤7ï¼šè·å–å½“å‰æ—¶é—´å¹¶è®¾ç½®ä¸ºç¯å¢ƒå˜é‡
      - name: è·å–å½“å‰æ—¶é—´
        id: current_time
        run: |
          echo "time=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

      # æ­¥éª¤8ï¼šå‘é€ Telegram é€šçŸ¥
      - name: å‘é€ Telegram é€šçŸ¥
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ğŸ“¢ é€šçŸ¥
            ğŸš€ æ¥æºï¼šGitHub Actions
            âœ‰ï¸ æ ‡é¢˜ï¼šåŒæ­¥ Surge ä¸Šæ¸¸æ¨¡å—
            ğŸ“¦ ä»“åº“ï¼šJK567
            â° æ—¶é—´ï¼š${{ env.time }}
            ğŸ‰ çŠ¶æ€ï¼šæ­å–œä½ ï¼å…¨éƒ¨ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ

      # 9. æ¸…ç†æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
      - name: æ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0          # æ¸…é™¤æ‰€æœ‰è¿‡æœŸè®°å½•
          keep_minimum_runs: 5    # è‡³å°‘ä¿ç•™æœ€è¿‘ 5 æ¬¡è¿è¡Œè®°å½•