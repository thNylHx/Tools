name: Surge æ¨¡å—æ‹‰å–

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  schedule:
    - cron: "15 */6 * * *"  # å®šæ—¶è§¦å‘ï¼Œæ¯8å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆæ­¤å¤„ä¸ºUTCæ—¶é—´ï¼Œå®é™…è§¦å‘æ—¶é—´ä»¥è§¦å‘å™¨è®¾ç½®ä¸ºå‡†ï¼‰

jobs:
  Fork-FLITER-list:
    runs-on: ubuntu-latest  # åœ¨æœ€æ–°ç‰ˆæœ¬çš„ Ubuntu ç¯å¢ƒä¸­è¿è¡Œå·¥ä½œæµ
    env:
      TZ: 'Asia/Shanghai'  # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·æ—¶é—´

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºç›®æ ‡ä»“åº“ï¼ˆTools ä»“åº“ï¼‰
      - name: æ£€å‡º Tools ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: thNylHx/Tools  # æŒ‡å®šè¦æ£€å‡ºçš„ä»“åº“
          path: Tools                # å°†ä»“åº“æ£€å‡ºåˆ°æœ¬åœ°ç›®å½• Tools ä¸‹
      # è¯´æ˜ï¼šæ£€å‡ºç›®æ ‡ä»“åº“ä»£ç ï¼Œåç»­å°†åœ¨è¯¥ä»“åº“å†…æ›´æ–° Surge/QingRex ç›®å½•

      # æ­¥éª¤2ï¼šè®¾ç½® Git ç”¨æˆ·é…ç½®ï¼ˆç”¨äºåç»­æäº¤ï¼‰
      - name: è®¾ç½® Git é…ç½®
        run: |
          git config --global user.name "${{ secrets.USERNAME }}"
          git config --global user.email "${{ secrets.EMAIL }}"
      # è¯´æ˜ï¼šé…ç½® Git ç”¨æˆ·åå’Œé‚®ç®±ï¼Œç”¨äºæäº¤è®°å½•

      # æ­¥éª¤3ï¼šå…‹éš† LoonKissSurge æºä»“åº“
      - name: å…‹éš† LoonKissSurge ä»“åº“
        run: |
          rm -rf "${{ github.workspace }}/LoonKissSurge"  # æ¸…ç†æ—§çš„ç›®å½•
          git clone "https://github.com/QingRex/LoonKissSurge.git" "${{ github.workspace }}/LoonKissSurge" \
            && echo "æˆåŠŸå…‹éš† LoonKissSurge ä»“åº“" \
            || { echo "å…‹éš†å¤±è´¥ï¼Œé€€å‡ºã€‚"; exit 1; }
      # è¯´æ˜ï¼šå…‹éš†æ•´ä¸ª LoonKissSurge ä»“åº“ï¼Œä½œä¸ºåŒæ­¥çš„æºä»“åº“

      # æ­¥éª¤4ï¼šé‡å»º Surge/QingRex ç›®å½•
      - name: é‡å»º Surge/QingRex ç›®å½•
        run: |
          TARGET_DIR="${{ github.workspace }}/Tools/Surge/QingRex"
          rm -rf "$TARGET_DIR" && mkdir -p "$TARGET_DIR"
          echo "å·²é‡å»ºç›®å½• $TARGET_DIRã€‚"
      # è¯´æ˜ï¼šæ¸…ç©º Tools ä»“åº“ä¸­ Surge/QingRex ç›®å½•ï¼Œç¡®ä¿åŒæ­¥æ—¶ä¸ä¼šæ··å…¥æ—§æ–‡ä»¶

      # æ­¥éª¤5ï¼šå¤åˆ¶æ•´ä¸ª LoonKissSurge ä»“åº“å†…å®¹åˆ° Surge/QingRex ç›®å½•
      - name: å¤åˆ¶ LoonKissSurge ä»“åº“å†…å®¹åˆ° Surge/QingRex
        run: |
          cp -r "${{ github.workspace }}/LoonKissSurge/." "${{ github.workspace }}/Tools/Surge/QingRex/" \
            && echo "å·²åŒæ­¥æ•´ä¸ª LoonKissSurge ä»“åº“å†…å®¹åˆ° Surge/QingRex" \
            || { echo "å¤åˆ¶æ–‡ä»¶å¤±è´¥ï¼Œé€€å‡ºã€‚"; exit 1; }
      # è¯´æ˜ï¼šå°† LoonKissSurge ä»“åº“ä¸­çš„æ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ°ç›®æ ‡ç›®å½• Surge/QingRex

      # æ­¥éª¤6ï¼šè®¾ç½® Tools ä»“åº“è¿œç¨‹ URLï¼ˆä½¿ç”¨ TOKEN è¿›è¡Œèº«ä»½éªŒè¯ï¼‰
      - name: ä¸º Tools ä»“åº“è®¾ç½®è¿œç¨‹ URL
        run: |
          cd "${{ github.workspace }}/Tools"
          git remote set-url origin "https://x-access-token:${{ secrets.TOKEN }}@github.com/${{ secrets.USERNAME }}/Tools.git"
      # è¯´æ˜ï¼šä¿®æ”¹è¿œç¨‹ URLï¼Œä½¿ç”¨ä»¤ç‰Œè¿›è¡Œæ¨é€èº«ä»½éªŒè¯

      # æ­¥éª¤7ï¼šæ£€æŸ¥æ›´æ”¹å¹¶æ¨é€åˆ° Tools ä»“åº“ï¼ˆåˆ†æ”¯ï¼šmainï¼‰
      - name: æ£€æŸ¥æ›´æ”¹å¹¶æ¨é€åˆ° GitHub Tools ä»“åº“
        id: push_changes
        run: |
          cd "${{ github.workspace }}/Tools"
          git fetch origin
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "Auto Update $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin main && echo "åŒæ­¥å®Œæˆï¼"
          else
            echo "æ²¡æœ‰æœ¬åœ°å˜æ›´ï¼Œæ— éœ€åŒæ­¥ã€‚"
          fi
      # è¯´æ˜ï¼šå¦‚æœ Tools ä»“åº“å†…æœ‰æ”¹åŠ¨ï¼Œåˆ™æäº¤æ›´æ”¹å¹¶æ¨é€åˆ° main åˆ†æ”¯

      # æ­¥éª¤8ï¼šå‘é€ Telegram æ¨é€é€šçŸ¥
      - name: Telegram æ¨é€é€šçŸ¥
        run: |
          MESSAGE=$'ğŸ“¢  é€šçŸ¥\nâœ‰ï¸  æ ‡é¢˜ï¼šSurge æ¨¡å—æ‹‰å–\nğŸ””  çŠ¶æ€ï¼šGitHub Actions æ‰§è¡Œå®Œæˆ\nâ°  æ—¶é—´ï¼š'"$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          curl -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${MESSAGE}"
      # è¯´æ˜ï¼šè°ƒç”¨ Telegram Bot API å‘é€é€šçŸ¥ï¼Œå‘ŠçŸ¥åŒæ­¥ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€

      # æ­¥éª¤9ï¼šæ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•ï¼ˆå¯é€‰ï¼‰
      - name: æ¸…ç†å·¥ä½œæµ
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 5
      # è¯´æ˜ï¼šåˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•ï¼Œä¿æŒä»“åº“æ•´æ´ï¼ˆå¯é€‰ï¼‰
