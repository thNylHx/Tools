name: åŒæ­¥ LoonKissSurge ä»“åº“å†…å®¹

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  schedule:
    - cron: "15 */6 * * *"  # æ¯6å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰

jobs:
  sync-loonkisssurge:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ Ubuntu è¿è¡Œå™¨
    env:
      TZ: 'Asia/Shanghai'  # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·æ—¶é—´

    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºå½“å‰ä»“åº“
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: thNylHx/Tools  # æ›¿æ¢ä¸ºæ‚¨çš„ä»“åº“å
          path: Tools                # å°†ä»“åº“æ£€å‡ºåˆ°æœ¬åœ°ç›®å½• Tools ä¸‹

      # æ­¥éª¤ 2ï¼šè®¾ç½® Git ç”¨æˆ·é…ç½®
      - name: è®¾ç½® Git é…ç½®
        run: |
          git config --global user.name "${{ secrets.USERNAME }}"
          git config --global user.email "${{ secrets.EMAIL }}"
        # ç¡®ä¿åœ¨ä»“åº“çš„ Secrets ä¸­è®¾ç½®äº† USERNAME å’Œ EMAIL

      # æ­¥éª¤ 3ï¼šå…‹éš† LoonKissSurge ä»“åº“
      - name: å…‹éš† LoonKissSurge ä»“åº“
        run: |
          rm -rf "${{ github.workspace }}/LoonKissSurge"  # æ¸…ç†æ—§çš„ç›®å½•
          git clone "https://github.com/QingRex/LoonKissSurge.git" "${{ github.workspace }}/LoonKissSurge" \
            && echo "æˆåŠŸå…‹éš† LoonKissSurge ä»“åº“" \
            || { echo "å…‹éš†å¤±è´¥ï¼Œé€€å‡ºã€‚"; exit 1; }

      # æ­¥éª¤ 4ï¼šæ¸…ç†å¹¶åˆ›å»ºç›®æ ‡ç›®å½•
      - name: é‡å»º Surge/QingRex ç›®å½•
        run: |
          TARGET_DIR="${{ github.workspace }}/Tools/Surge/QingRex"
          rm -rf "$TARGET_DIR" && mkdir -p "$TARGET_DIR"
          echo "å·²é‡å»ºç›®å½• $TARGET_DIRã€‚"

      # æ­¥éª¤ 5ï¼šå¤åˆ¶ LoonKissSurge ä»“åº“å†…å®¹åˆ°ç›®æ ‡ç›®å½•
      - name: å¤åˆ¶ LoonKissSurge ä»“åº“å†…å®¹åˆ° Surge/QingRex
        run: |
          cp -r "${{ github.workspace }}/LoonKissSurge/." "${{ github.workspace }}/Tools/Surge/QingRex/" \
            && echo "å·²åŒæ­¥ LoonKissSurge ä»“åº“å†…å®¹åˆ° Surge/QingRex" \
            || { echo "å¤åˆ¶æ–‡ä»¶å¤±è´¥ï¼Œé€€å‡ºã€‚"; exit 1; }

      # æ­¥éª¤ 6ï¼šè®¾ç½® Tools ä»“åº“çš„è¿œç¨‹ URLï¼ˆä½¿ç”¨ TOKEN è¿›è¡Œèº«ä»½éªŒè¯ï¼‰
      - name: ä¸º Tools ä»“åº“è®¾ç½®è¿œç¨‹ URL
        run: |
          cd "${{ github.workspace }}/Tools"
          git remote set-url origin "https://x-access-token:${{ secrets.TOKEN }}@github.com/${{ secrets.USERNAME }}/Tools.git"
        # ç¡®ä¿åœ¨ä»“åº“çš„ Secrets ä¸­è®¾ç½®äº† TOKEN å’Œ USERNAME

      # æ­¥éª¤ 7ï¼šæ£€æŸ¥æ›´æ”¹å¹¶æ¨é€åˆ° Tools ä»“åº“çš„ main åˆ†æ”¯
      - name: æ£€æŸ¥æ›´æ”¹å¹¶æ¨é€åˆ° GitHub Tools ä»“åº“
        run: |
          cd "${{ github.workspace }}/Tools"
          git fetch origin
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "åŒæ­¥ LoonKissSurge æ›´æ–° $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin main && echo "åŒæ­¥å®Œæˆï¼"
          else
            echo "æ²¡æœ‰æœ¬åœ°å˜æ›´ï¼Œæ— éœ€åŒæ­¥ã€‚"
          fi

      # æ­¥éª¤ 8ï¼šå‘é€ Telegram æ¨é€é€šçŸ¥
      - name: å‘é€ Telegram æ¨é€é€šçŸ¥
        run: |
          MESSAGE=$'ğŸ“¢  é€šçŸ¥\nâœ‰ï¸  æ ‡é¢˜ï¼šLoonKissSurge åŒæ­¥\nğŸ””  çŠ¶æ€ï¼šGitHub Actions æ‰§è¡Œå®Œæˆ\nâ°  æ—¶é—´ï¼š'"$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          curl -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${MESSAGE}"
        # ç¡®ä¿åœ¨ä»“åº“çš„ Secrets ä¸­è®¾ç½®äº† TELEGRAM_TOKEN å’Œ TELEGRAM_CHAT_ID

      # æ­¥éª¤ 9ï¼šæ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•ï¼ˆå¯é€‰ï¼‰
      - name: æ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 5
