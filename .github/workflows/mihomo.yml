name: åŒæ­¥ mihomo ä¸Šæ¸¸è§„åˆ™

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  Fork:
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Shanghai'

    steps:
      - name: æ£€å‡ºç›®æ ‡ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: thNylHx/Tools
          path: Tools-repo

      - name: æ‰§è¡Œå†…åµŒè„šæœ¬
        run: |
          #!/bin/bash
          repo_name=$(basename "$GITHUB_REPOSITORY")
          if [[ "$repo_name" == "Tools" ]]; then
              echo "Running in Tools repository"
              mkdir -p Tools-repo/Ruleset/mihomo/{geoip,geosite}
              files=(
                  # geosite
                  "geosite/Ads_all.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/category-ads-all.mrs"
                  "geosite/Local.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/private.mrs"
                  "geosite/China.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/cn.mrs"
                  "geosite/Openai.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/openai.mrs"
                  "geosite/PayPal.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/paypal.mrs"
                  "geosite/Apple.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/apple.mrs"
                  "geosite/Global.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/geolocation-!cn.mrs"
                  "geosite/Google.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/google.mrs"
                  "geosite/YouTube.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/youtube.mrs"
                  "geosite/Steam.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/steam.mrs"
                  "geosite/Epic.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/epicgames.mrs"
                  "geosite/Facebook.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/facebook.mrs"
                  "geosite/Instagram.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/instagram.mrs"
                  "geosite/Twitter.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/twitter.mrs"
                  "geosite/telegram.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/telegram.mrs"
                  "geosite/Line.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/line.mrs"
                  "geosite/GitHub.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/github.mrs"
                  "geosite/OneDrive.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/onedrive.mrs"
                  "geosite/Microsoft.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/microsoft.mrs"
                  "geosite/tiktok.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/tiktok.mrs"
                  "geosite/Bilibili.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/bilibili.mrs"
                  "geosite/Disney.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/disney.mrs"
                  "geosite/Netflix.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/netflix.mrs"
                  "geosite/Spotify.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/spotify.mrs"

                  # geoip
                  "geoip/Local.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/private.mrs"
                  "geoip/China.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/cn.mrs"
                  "geoip/Netflix.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/netflix.mrs"
                  "geoip/Twitter.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/twitter.mrs"
                  "geoip/telegram.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/telegram.mrs"
                  "geoip/Facebook.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/facebook.mrs"
                  "geoip/Google.mrs https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/google.mrs"
              )
              for file in "${files[@]}"; do
                  file_name=$(echo $file | cut -d " " -f 1)
                  url=$(echo $file | cut -d " " -f 2)
                  # ç¡®ä¿ URL æ ¼å¼æ­£ç¡®
                  if [[ ! "$url" =~ ^https?: ]]; then
                      url="https:$url"
                  fi
                  echo "Downloading: $file_name"
                  curl -f -L "$url" -o "Tools-repo/Ruleset/mihomo/$file_name" || { echo "Download Failed: $url"; exit 1; }
              done
          else
              echo "This is not the Tools repository. Skipping."
          fi
        shell: bash

      - name: æ¨é€åˆ°ä»“åº“
        run: |
          cd Tools-repo  # åˆ‡æ¢åˆ°å·²æ£€å‡ºçš„ç›®æ ‡ä»“åº“ç›®å½•
          # æ£€æŸ¥å½“å‰ git çŠ¶æ€ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨æ–‡ä»¶æ›´æ”¹ï¼ˆgit status -s æœ‰è¾“å‡ºè¡¨ç¤ºæœ‰æ›´æ”¹ï¼‰
          if [[ -n $(git status -s) ]]; then  # å¦‚æœå­˜åœ¨æœªæäº¤çš„æ›´æ”¹ï¼Œåˆ™æ‰§è¡Œæäº¤æ“ä½œ
            echo "å‘ç°æ›´æ–°ï¼Œå‡†å¤‡æäº¤..."  # è¾“å‡ºæç¤ºä¿¡æ¯ï¼Œè¡¨ç¤ºæ£€æµ‹åˆ°æ›´æ–°
            git config --local user.email "action@github.com"  # é…ç½®æœ¬åœ° git ç”¨æˆ·é‚®ç®±
            git config --local user.name "GitHub Action"  # é…ç½®æœ¬åœ° git ç”¨æˆ·å
            git add .  # å°†æ‰€æœ‰æ›´æ”¹æ·»åŠ åˆ° git æš‚å­˜åŒº
            # æäº¤æ›´æ”¹ï¼Œæäº¤ä¿¡æ¯ä¸­åŒ…å«å½“å‰ä¸Šæµ·æ—¶åŒºçš„æ—¶é—´æˆ³
            git commit -m "Auto Update $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"  # æäº¤æ›´æ–°å¹¶æ ‡æ³¨æäº¤æ—¶é—´
            git push origin HEAD  # å°†æœ¬æ¬¡æäº¤æ¨é€åˆ°è¿œç¨‹ä»“åº“å½“å‰åˆ†æ”¯
            echo "æ›´æ–°å·²æ¨é€åˆ°ä»“åº“"  # è¾“å‡ºæç¤ºä¿¡æ¯ï¼Œè¡¨ç¤ºæ¨é€æ“ä½œå·²å®Œæˆ
          else  # è‹¥æ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•æ›´æ”¹
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"  # è¾“å‡ºæç¤ºä¿¡æ¯ï¼Œè¡¨ç¤ºå½“å‰æ²¡æœ‰æ–‡ä»¶æ›´æ”¹éœ€è¦æäº¤
          fi  # ç»“æŸ if æ¡ä»¶åˆ¤æ–­

      - name: è·å–å½“å‰æ—¶é—´
        id: current_time
        run: |
          echo "time=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

      - name: å‘é€ Telegram é€šçŸ¥
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ğŸ“¢ é€šçŸ¥
            ğŸš€ æ¥æºï¼šGitHub Actions
            âœ‰ï¸ æ ‡é¢˜ï¼šåŒæ­¥ mihomo ä¸Šæ¸¸è§„åˆ™
            ğŸ“¦ ä»“åº“ï¼šJK567
            â° æ—¶é—´ï¼š${{ env.time }}
            ğŸ‰ çŠ¶æ€ï¼šæ­å–œä½ ï¼å…¨éƒ¨ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ

      - name: æ¸…ç†å·¥ä½œæµ
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 5